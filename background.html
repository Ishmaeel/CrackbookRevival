<html>
<head>

  <script>

    var HITNUM_FONT = '12px Arial Bold';
    var HITNUM_COLOR = "rgb(255,255,255)";
    var HITNUM_POS_X = 3;
    var HITNUM_POS_Y = 12;
    var NOTIFICATION_THRESHOLD = 20;
    var NOTIFICATION_HIT_INTERVAL = 10;

    var NOTIFICATION_OBJ = webkitNotifications.createNotification(
            'images/Hamburger-128px.png',
            'Time to get back to work!',
            "");

    function drawIcon(value) {
      var canvas = document.getElementById("iconCanvas");
      
      var image = new Image();
      image.src = "images/hamburger.png";
      image.onload = function() { drawTextOnBg(canvas, image, value); };
    } // drawIcon

    function drawTextOnBg(canvas, image, value) {
      var ctx = canvas.getContext('2d');

      ctx.drawImage(image, 0, 0);

      ctx.font = HITNUM_FONT;
      ctx.fillStyle = HITNUM_COLOR;
      ctx.fillText("" + value, HITNUM_POS_X, HITNUM_POS_Y);

      var imageData = ctx.getImageData(0, 0, 19, 19);
      chrome.browserAction.setIcon({imageData: imageData});
    } // drawTextOnBg

    function getTodaysHits() {
    }

    // Returns today's date as an ISO8601 string (2011-03-04)
    function todayAsString() {
      return new Date().toISOString().slice(0, 10);
    }

    function onVisitedHandler(histItem) {
      if (!histItem.url)
        return;
      var domains = getJunkDomains();
      for (var i = 0; i < domains.length; i++) {
        if (histItem.url.indexOf(domains[i]) == 0) {
          hit(domains[i]);
          return;
        }
      }
    }

    function hit(domain) {
      // Update icon.
      var hist = getHitHistory();
      var today = todayAsString();
      if (!hist[today])
        hist[today] = 0;
      hist[today] += 1;
      setHitHistory(hist); // Save incremented hit.
      drawIcon(hist[today]);

      // TODO: store hit on associated domain

      // Show notification if needed.
      if (hist[today] > NOTIFICATION_THRESHOLD
          && (hist[today] % NOTIFICATION_HIT_INTERVAL == 0)) {
        NOTIFICATION_OBJ.show();
      }
    }

    function getHitHistory() {
      if (!('hitHistory' in localStorage)) {
        localStorage.setItem('hitHistory', '{}');
      }
      var s = localStorage.getItem('hitHistory');
      return JSON.parse(s);
    }

    function setHitHistory(hist) {
      localStorage.setItem('hitHistory', JSON.stringify(hist));
    }

    function getJunkDomains() {
      // TODO: load from local storage
      return ['http://www.facebook.com', 'http://www.reddit.com'];
    }

    function setJunkDomains(domains) {
      // TODO: store in local storage
    }

    function initIcon() {
      var hist = getHitHistory();
      var today = todayAsString();
      if (!hist[today])
        hist[today] = 0;
      drawIcon(hist[today]);
    }

    function initExtension() {
      initIcon();
      chrome.history.onVisited.addListener(onVisitedHandler);
    }

  </script>

  <!-- Google Analytics -->
  <script>
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-6080477-5']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = 'https://ssl.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>

</head>

<body>

  <canvas id="iconCanvas" width="19" height="19" />

  <script>
    initExtension();
  </script>
</body>
</html>
